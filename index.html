<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emergency Cart Smart Check</title>
    
    <!-- FAVICON -->
    <link rel="icon" type="image/png" href="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRYfBIvo5I6imKO2PO2Q685aje7a48lvI5rrQ&s">

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', 'Prompt', sans-serif; }
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        .animate-slide-up { animation: slideUp 0.4s ease-out; }
        .animate-spin-slow { animation: spin 2s linear infinite; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="bg-[#F8FAFC] text-slate-800 min-h-screen"> 

    <div id="root"></div>

    <script type="text/babel">
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbwNpFNcLm0iU6vTF0DM7UwONFl3NGXmySuR1jXh-mWyZjbtqf_BTkTpjOYs3NXBzRU/exec"; 

        const { useState, useEffect, useMemo } = React;
        
        // --- HELPER FUNCTIONS ---
        const formatDate = (dateStr) => {
            if(!dateStr) return "-";
            try {
                const d = new Date(dateStr);
                return d.toLocaleDateString('th-TH', { year: 'numeric', month: 'short', day: 'numeric' });
            } catch(e) { return "-"; }
        };

        const getDaysDiff = (targetDate) => {
            if (!targetDate) return 999;
            const today = new Date();
            today.setHours(0,0,0,0);
            const target = new Date(targetDate);
            target.setHours(0,0,0,0);
            return Math.ceil((target - today) / (1000 * 60 * 60 * 24));
        };

        // --- Error Boundary ---
        class ErrorBoundary extends React.Component {
            constructor(props) { super(props); this.state = { hasError: false }; }
            static getDerivedStateFromError(error) { return { hasError: true }; }
            componentDidCatch(error, errorInfo) { console.error(error, errorInfo); }
            render() {
                if (this.state.hasError) return <div className="p-8 text-center text-red-600">ระบบขัดข้อง กรุณารีโหลดหน้าเว็บ</div>;
                return this.props.children; 
            }
        }

        // --- ICONS ---
        const Icons = {
            Plus: <path d="M12 5v14M5 12h14" />,
            History: <path d="M3 3v5h5M3.05 13A9 9 0 1 0 6 5.3L3 8" />,
            CheckCircle: <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14M22 4L12 14.01l-3-3" />,
            XCircle: <><circle cx="12" cy="12" r="10" /><path d="M15 9l-6 6M9 9l6 6" /></>,
            Calendar: <><rect x="3" y="4" width="18" height="18" rx="2" ry="2" /><line x1="16" y1="2" x2="16" y2="6" /><line x1="8" y1="2" x2="8" y2="6" /><line x1="3" y1="10" x2="21" y2="10" /></>,
            Save: <><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" /><polyline points="17 21 17 13 7 13 7 21" /><polyline points="7 3 7 8 15 8" /></>,
            AlertTriangle: <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0zM12 9v4M12 17h.01" />,
            ChevronLeft: <polyline points="15 18 9 12 15 6" />,
            RotateCcw: <><path d="M1 4v6h6" /><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10" /></>,
            ChevronDown: <polyline points="6 9 12 15 18 9" />,
            FileText: <><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" /><polyline points="14 2 14 8 20 8" /><line x1="16" y1="13" x2="8" y2="13" /><line x1="16" y1="17" x2="8" y2="17" /><polyline points="10 9 9 9 8 9" /></>,
            Layers: <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" />,
            Trash: <><polyline points="3 6 5 6 21 6" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /></>,
            Edit: <><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" /><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" /></>,
            Wrench: <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z" />,
            Settings: <><circle cx="12" cy="12" r="3" /><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" /></>,
            Close: <><line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" /></>
        };

        const SimpleIcon = ({ name, className = "w-5 h-5", color = "currentColor" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{Icons[name]}</svg>
        );

        // --- DATA DEFS ---
        const ITEM_TYPES = { 
            QTY_STATUS: 'qty_status', 
            QTY_EXP_STATUS: 'qty_exp_status', 
            CHECK_HAVE: 'check_have', 
            STATUS_ONLY: 'status_only' 
        };
        
        const DEFAULT_ITEMS = [
            { id: 'cardiac_board', name: 'Cardiac board', required: 1, type: ITEM_TYPES.QTY_STATUS, category: 'ชั้นบน' },
            { id: 'cpr_box', name: 'กล่องยา CPR', required: 1, type: ITEM_TYPES.QTY_EXP_STATUS, category: 'ชั้นบน' },
            { id: 'acs_box', name: 'กล่องยา ACS', required: 1, type: ITEM_TYPES.QTY_EXP_STATUS, category: 'ชั้นบน' },
            { id: 'laryngoscope', name: 'Laryngoscope', required: 1, type: ITEM_TYPES.QTY_STATUS, category: 'ชั้นบน' },
            { id: 'flashlight', name: 'ไฟฉาย', required: 1, type: ITEM_TYPES.QTY_STATUS, category: 'ชั้นบน' },
            { id: 'mask', name: 'Mask', required: 3, type: ITEM_TYPES.QTY_EXP_STATUS, category: 'ลิ้นชักชั้นที่ 1' },
            { id: 'airway_7', name: 'Airway NO.7', type: ITEM_TYPES.QTY_EXP_STATUS, category: 'ลิ้นชักชั้นที่ 1' },
            { id: 'airway_8', name: 'Airway NO.8', type: ITEM_TYPES.QTY_EXP_STATUS, category: 'ลิ้นชักชั้นที่ 1' },
            { id: 'airway_9', name: 'Airway NO.9', type: ITEM_TYPES.QTY_EXP_STATUS, category: 'ลิ้นชักชั้นที่ 1' },
            { id: 'airway_10', name: 'Airway NO.10', type: ITEM_TYPES.QTY_EXP_STATUS, category: 'ลิ้นชักชั้นที่ 1' },
            { id: 'syringe_5', name: 'Syringe 5 CC', type: ITEM_TYPES.QTY_EXP_STATUS, category: 'ลิ้นชักชั้นที่ 1' },
            { id: 'syringe_10', name: 'Syringe 10 CC', type: ITEM_TYPES.QTY_EXP_STATUS, category: 'ลิ้นชักชั้นที่ 1' },
            { id: 'needle_18', name: 'Needle NO.18', type: ITEM_TYPES.QTY_EXP_STATUS, category: 'ลิ้นชักชั้นที่ 1' },
            { id: 'needle_23', name: 'Needle NO.23', type: ITEM_TYPES.QTY_EXP_STATUS, category: 'ลิ้นชักชั้นที่ 1' },
            { id: 'ky_jelly', name: 'KY Jelly', type: ITEM_TYPES.QTY_EXP_STATUS, category: 'ลิ้นชักชั้นที่ 1' },
            { id: 'guide_wire', name: 'Guide wire', required: 5, type: ITEM_TYPES.QTY_EXP_STATUS, category: 'ลิ้นชักชั้นที่ 2' },
            { id: 'ett_5', name: 'ETT NO. 5', required: 2, type: ITEM_TYPES.QTY_EXP_STATUS, category: 'ลิ้นชักชั้นที่ 2' },
            { id: 'ett_5_5', name: 'ETT NO. 5.5', required: 2, type: ITEM_TYPES.QTY_EXP_STATUS, category: 'ลิ้นชักชั้นที่ 2' },
            { id: 'ett_6', name: 'ETT NO. 6', required: 2, type: ITEM_TYPES.QTY_EXP_STATUS, category: 'ลิ้นชักชั้นที่ 2' },
            { id: 'ett_6_5', name: 'ETT NO. 6.5', required: 2, type: ITEM_TYPES.QTY_EXP_STATUS, category: 'ลิ้นชักชั้นที่ 2' },
            { id: 'ett_7', name: 'ETT NO. 7', required: 2, type: ITEM_TYPES.QTY_EXP_STATUS, category: 'ลิ้นชักชั้นที่ 2' },
            { id: 'ett_7_5', name: 'ETT NO. 7.5', required: 2, type: ITEM_TYPES.QTY_EXP_STATUS, category: 'ลิ้นชักชั้นที่ 2' },
            { id: 'ett_8', name: 'ETT NO. 8', required: 2, type: ITEM_TYPES.QTY_EXP_STATUS, category: 'ลิ้นชักชั้นที่ 2' },
            { id: 'suction_14', name: 'Suction NO.14', required: 5, type: ITEM_TYPES.QTY_EXP_STATUS, category: 'ลิ้นชักชั้นที่ 2' },
            { id: 'suction_16', name: 'Suction NO.16', required: 5, type: ITEM_TYPES.QTY_EXP_STATUS, category: 'ลิ้นชักชั้นที่ 2' },
            { id: 'plaster', name: 'พลาสเตอร์ติด Tube', type: ITEM_TYPES.CHECK_HAVE, category: 'ลิ้นชักชั้นที่ 3' },
            { id: 'sterile_gloves', name: 'ถุงมือ Sterile', type: ITEM_TYPES.CHECK_HAVE, category: 'ลิ้นชักชั้นที่ 3' },
            { id: 'gauze', name: 'Gauze', type: ITEM_TYPES.CHECK_HAVE, category: 'ลิ้นชักชั้นที่ 3' },
            { id: 'tongue_depressor', name: 'ไม้กดลิ้น', type: ITEM_TYPES.CHECK_HAVE, category: 'ลิ้นชักชั้นที่ 3' },
            { id: 'ambubag', name: 'Adult ambubag', required: 1, type: ITEM_TYPES.QTY_EXP_STATUS, category: 'ตู้ล่างขวา' },
            { id: 'general_readiness', name: 'ความพร้อมทั่วไปรถ Emergency', type: ITEM_TYPES.STATUS_ONLY, category: 'General' },
        ];

        const CATEGORY_ORDER = ['ชั้นบน', 'ลิ้นชักชั้นที่ 1', 'ลิ้นชักชั้นที่ 2', 'ลิ้นชักชั้นที่ 3', 'ตู้ล่างขวา', 'General'];

        // --- GLOBAL LOGIC ---
        const getAbnormalities = (rec, itemsDef) => {
            const list = [];
            if(!rec) return list;
            const currentItemsDef = itemsDef || DEFAULT_ITEMS;
            if(rec.items) {
                Object.entries(rec.items).forEach(([key, val]) => {
                    const def = currentItemsDef.find(i => i.id === key);
                    if(!def || key === 'general_readiness') return;
                    if (def.type === ITEM_TYPES.CHECK_HAVE) {
                        if (!val.checked) list.push({ name: def.name, issue: 'ไม่มี', note: val.note });
                    } else {
                        if (val.status === 'not_ready') list.push({ name: def.name, issue: 'ไม่พร้อม', note: val.note });
                    }
                    if (val.exp) {
                        const days = getDaysDiff(val.exp);
                        if (days < 0) list.push({ name: def.name, issue: 'หมดอายุ', note: formatDate(val.exp) });
                    }
                });
            }
            return list;
        };

        // --- COMPONENTS ---
        const Modal = ({ isOpen, title, children, onClose }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 p-4 backdrop-blur-sm animate-fade-in">
                    <div className="bg-white rounded-[32px] shadow-2xl w-full max-w-[400px] overflow-hidden animate-slide-up">
                        <div className="px-6 py-5 flex justify-between items-center border-b border-slate-50">
                            <h3 className="text-xl font-bold text-slate-800">{title}</h3>
                            <button onClick={onClose} className="text-slate-400 hover:text-slate-600 transition-colors">
                                <SimpleIcon name="XCircle" className="w-7 h-7" />
                            </button>
                        </div>
                        <div className="p-6">{children}</div>
                    </div>
                </div>
            );
        };

        const ExpirationAlerts = ({ alerts }) => {
            if (!alerts || alerts.length === 0) return null;
            return (
                <div className="mt-6 space-y-2 text-left">
                    <h4 className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2 px-1">แจ้งเตือนยาและเวชภัณฑ์</h4>
                    {alerts.map((item, idx) => (
                        <div key={idx} className={`p-3 rounded-2xl border flex items-center gap-3 ${item.status === 'expired' ? 'bg-red-50 border-red-100 text-red-700' : 'bg-orange-50 border-orange-100 text-orange-700'}`}>
                            <SimpleIcon name="AlertTriangle" className="w-5 h-5 shrink-0" />
                            <div className="text-sm font-semibold">{item.name} {item.status === 'expired' ? 'หมดอายุแล้ว' : `ใกล้หมดอายุ (${formatDate(item.date)})`}</div>
                        </div>
                    ))}
                </div>
            );
        };

        const CategorySection = ({ category, items, formData, updateItem, ITEM_TYPES }) => {
            const [isOpen, setIsOpen] = useState(true);
            return (
                <div className="border-t border-slate-100 first:border-t-0">
                    <div onClick={() => setIsOpen(!isOpen)} className="bg-slate-50 px-6 py-3 text-xs font-bold text-slate-500 uppercase flex items-center justify-between cursor-pointer">
                        <span>{category}</span>
                        <SimpleIcon name="ChevronDown" className={`transition-transform ${isOpen ? 'rotate-180' : ''}`} />
                    </div>
                    {isOpen && (
                        <div className="divide-y divide-slate-50">
                            {items.map(item => (
                                <div key={item.id} className="p-6">
                                    <div className="flex justify-between items-start gap-4">
                                        <div>
                                            <div className="font-bold text-slate-800">{item.name}</div>
                                            {item.required && <div className="text-xs text-slate-400 font-medium">ควรมี: {item.required}</div>}
                                        </div>
                                        <div className="flex p-1 bg-slate-100 rounded-xl">
                                            {item.type === ITEM_TYPES.CHECK_HAVE ? (
                                                <>
                                                    <button onClick={() => updateItem(item.id, 'checked', true)} className={`px-4 py-2 rounded-lg text-xs font-bold transition-all ${formData.items[item.id]?.checked === true ? 'bg-white text-emerald-600 shadow-sm' : 'text-slate-400'}`}>มี</button>
                                                    <button onClick={() => updateItem(item.id, 'checked', false)} className={`px-4 py-2 rounded-lg text-xs font-bold transition-all ${formData.items[item.id]?.checked === false ? 'bg-white text-red-500 shadow-sm' : 'text-slate-400'}`}>ไม่มี</button>
                                                </>
                                            ) : (
                                                <>
                                                    <button onClick={() => updateItem(item.id, 'status', 'ready')} className={`px-4 py-2 rounded-lg text-xs font-bold transition-all ${formData.items[item.id]?.status === 'ready' ? 'bg-white text-emerald-600 shadow-sm' : 'text-slate-400'}`}>พร้อม</button>
                                                    <button onClick={() => updateItem(item.id, 'status', 'not_ready')} className={`px-4 py-2 rounded-lg text-xs font-bold transition-all ${formData.items[item.id]?.status === 'not_ready' ? 'bg-white text-red-500 shadow-sm' : 'text-slate-400'}`}>ไม่พร้อม</button>
                                                </>
                                            )}
                                        </div>
                                    </div>
                                    {item.type.includes('qty') && (
                                        <div className="mt-3"><input type="number" placeholder="ระบุจำนวน" className="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-sm" value={formData.items[item.id]?.qty || ''} onChange={e => updateItem(item.id, 'qty', e.target.value)}/></div>
                                    )}
                                    {item.type.includes('exp') && (
                                        <div className="mt-3"><label className="block text-[10px] text-slate-400 mb-1">วันหมดอายุ</label><input type="date" className="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-sm" value={formData.items[item.id]?.exp || ''} onChange={e => updateItem(item.id, 'exp', e.target.value)}/></div>
                                    )}
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        // --- NEW COMPONENT FOR GROUPED HISTORY ---
        const MonthGroupHistory = ({ monthLabel, records }) => {
            const [isExpanded, setIsExpanded] = useState(true);
            return (
                <div className="mb-4">
                    <button 
                        onClick={() => setIsExpanded(!isExpanded)} 
                        className="w-full flex items-center justify-between p-3 bg-slate-100 hover:bg-slate-200 rounded-2xl transition-colors mb-2"
                    >
                        <div className="flex items-center gap-2">
                            <SimpleIcon name="Calendar" className="w-4 h-4 text-slate-400" />
                            <span className="font-bold text-slate-600 text-sm">{monthLabel}</span>
                            <span className="bg-white text-[10px] text-slate-400 px-2 py-0.5 rounded-full border border-slate-200 font-bold">{records.length} รายการ</span>
                        </div>
                        <SimpleIcon name="ChevronDown" className={`w-4 h-4 text-slate-400 transition-transform ${isExpanded ? 'rotate-180' : ''}`} />
                    </button>
                    {isExpanded && (
                        <div className="space-y-3 animate-fade-in pl-2 border-l-2 border-slate-100 ml-4">
                            {records.map(rec => (
                                <div key={rec.id} className="bg-white p-4 rounded-[24px] border border-slate-100 flex items-center justify-between shadow-sm">
                                    <div className="flex items-center gap-4">
                                        <div className="w-12 h-12 bg-slate-50 rounded-2xl flex items-center justify-center text-slate-400 text-xs font-bold uppercase">{rec.shift}</div>
                                        <div>
                                            <div className="font-bold text-slate-800 text-sm">{formatDate(rec.date)}</div>
                                            <div className="text-[10px] text-slate-400 font-medium">โดย: {rec.checker}</div>
                                        </div>
                                    </div>
                                    <div className={`text-[10px] font-bold px-3 py-1 rounded-full ${rec.generalReady === 'พร้อมใช้' ? 'bg-emerald-50 text-emerald-600 border border-emerald-100' : 'bg-red-50 text-red-600 border border-red-100'}`}>{rec.generalReady}</div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        // --- MAIN APP ---
        function App() {
            const [view, setView] = useState('dashboard');
            const [itemsDef, setItemsDef] = useState(DEFAULT_ITEMS); 
            const [records, setRecords] = useState([]);
            const [formData, setFormData] = useState({});
            const [lastStockCheck, setLastStockCheck] = useState(null);
            const [isLoading, setIsLoading] = useState(false);
            
            const [showTypeModal, setShowTypeModal] = useState(false);
            const [showCopyWarning, setShowCopyWarning] = useState(false);

            useEffect(() => { fetchData(); }, []);

            const fetchData = async () => {
                setIsLoading(true);
                try {
                    const res = await fetch(GAS_API_URL + '?action=read');
                    const json = await res.json();
                    if(json.status === 'success') {
                         setRecords((json.data || []).map(r => {
                             if (r.items && typeof r.items === 'string') {
                                 try { r.items = JSON.parse(r.items); } catch(e) { r.items = {}; }
                             }
                             return r;
                         }));
                    }
                    const resStock = await fetch(GAS_API_URL + '?action=getLastStockCheck');
                    const dataStock = await resStock.json();
                    if(dataStock.status === 'success' && dataStock.date) setLastStockCheck(new Date(dataStock.date));
                } catch (e) {
                    setRecords([{ id: 'mock', date: new Date().toISOString(), generalReady: 'พร้อมใช้', shift: 'เช้า', checker: 'Demo', items: {} }]);
                } finally { setIsLoading(false); }
            };

            const initForm = (prevData = null) => {
                const today = new Date().toISOString().split('T')[0];
                const savedChecker = localStorage.getItem('last_checker') || '';
                let initialItems = {};
                itemsDef.forEach(i => initialItems[i.id] = { qty: '', exp: '', status: null, checked: null, note: '' });

                if (prevData) {
                    Object.entries(prevData.items || {}).forEach(([k, v]) => {
                        if (initialItems[k]) initialItems[k] = { ...v };
                    });
                }
                setFormData({ date: today, shift: 'เช้า', checker: savedChecker, items: initialItems, otherItems: [] });
            };

            const submitData = async () => {
                setIsLoading(true);
                const isReady = formData.items['general_readiness']?.status === 'ready';
                const statusStr = isReady ? 'พร้อมใช้' : 'ไม่พร้อมใช้';
                localStorage.setItem('last_checker', formData.checker);
                
                try {
                    await fetch(GAS_API_URL, {
                        method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'text/plain' },
                        body: JSON.stringify({ ...formData, generalReady: statusStr, id: Date.now() })
                    });
                    setTimeout(() => { setIsLoading(false); setView('dashboard'); fetchData(); }, 1500);
                } catch (e) { setIsLoading(false); }
            };

            const expirationAlerts = useMemo(() => {
                if (records.length === 0) return [];
                const latest = records[0];
                const alerts = [];
                Object.entries(latest.items || {}).forEach(([key, val]) => {
                    if (val.exp) {
                        const days = getDaysDiff(val.exp);
                        if (days <= 7) alerts.push({ name: itemsDef.find(i => i.id === key)?.name, date: val.exp, status: days < 0 ? 'expired' : 'soon' });
                    }
                });
                return alerts;
            }, [records, itemsDef]);

            // Grouping logic for history
            const groupedRecords = useMemo(() => {
                const groups = {};
                records.forEach(rec => {
                    const d = new Date(rec.date);
                    const label = d.toLocaleDateString('th-TH', { month: 'long', year: 'numeric' });
                    if (!groups[label]) groups[label] = [];
                    groups[label].push(rec);
                });
                return groups;
            }, [records]);

            const updateItem = (id, field, value) => setFormData(prev => ({ ...prev, items: { ...prev.items, [id]: { ...prev.items[id], [field]: value } } }));

            if (isLoading) return (
                <div className="min-h-screen flex flex-col items-center justify-center bg-white">
                    <div className="w-12 h-12 border-4 border-teal-100 border-t-teal-600 rounded-full animate-spin"></div>
                    <p className="mt-4 text-slate-400 font-medium">กำลังดำเนินการ...</p>
                </div>
            );

            return (
                <div className="max-w-md mx-auto min-h-screen bg-[#F8FAFC] pb-20 shadow-xl shadow-slate-200">
                    <header className="bg-white px-6 py-6 border-b border-slate-100 flex items-center justify-between sticky top-0 z-30">
                        <div className="flex items-center gap-3">
                            <img 
                                src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRYfBIvo5I6imKO2PO2Q685aje7a48lvI5rrQ&s" 
                                alt="Logo" 
                                className="w-12 h-12 rounded-xl object-cover shadow-sm"
                            />
                            <div>
                                <h1 className="text-lg font-extrabold text-slate-800 leading-none mb-1">Emergency Cart Check</h1>
                                <p className="text-[13px] font-bold text-slate-500">หอสงฆ์อาพาธ</p>
                            </div>
                        </div>
                        <button onClick={() => setView('report')} className="p-2 text-slate-400 hover:bg-slate-50 rounded-xl transition-colors"><SimpleIcon name="Calendar" /></button>
                    </header>

                    <main className="p-4">
                        {view === 'dashboard' && (
                            <div className="space-y-6 animate-fade-in">
                                {/* CARD STATUS */}
                                <div className="bg-white rounded-[40px] p-8 shadow-sm border border-slate-100 text-center relative overflow-hidden">
                                    <h2 className="text-slate-400 text-[10px] font-bold uppercase tracking-[2px] mb-4">ความพร้อมทั่วไปรถ EMERGENCY หอสงฆ์อาพาธ</h2>
                                    <div className={`text-6xl font-black mb-6 ${records[0]?.generalReady === 'พร้อมใช้' ? 'text-[#10B981]' : 'text-red-500'}`}>
                                        {records[0]?.generalReady || 'ยังไม่ระบุ'}
                                    </div>
                                    
                                    <div className="inline-flex items-center gap-2 bg-slate-50 px-5 py-2.5 rounded-2xl text-[13px] text-slate-600 mb-8 border border-slate-100 shadow-inner">
                                        <SimpleIcon name="RotateCcw" className="w-4 h-4 text-slate-300" />
                                        <span>กำหนด ReCheck Stock ครั้งถัดไป: วันที่ <span className="font-bold text-slate-800">{lastStockCheck ? formatDate(new Date(lastStockCheck.getTime() + 14 * 86400000)) : '12 ก.พ. 2569'}</span></span>
                                    </div>

                                    <button onClick={() => setShowTypeModal(true)} className="w-full bg-[#0F172A] hover:bg-slate-800 text-white py-4.5 rounded-[24px] shadow-xl shadow-slate-200 flex items-center justify-center gap-3 text-lg font-bold transition-transform active:scale-95">
                                        <SimpleIcon name="Plus" className="w-5 h-5 text-white" />
                                        <span>ตรวจสอบรถ</span>
                                    </button>

                                    <ExpirationAlerts alerts={expirationAlerts} />
                                </div>

                                {/* HISTORY SECTION (IMAGE 3) - Grouped by Month */}
                                <div className="space-y-3">
                                    <h3 className="text-sm font-bold text-slate-400 uppercase tracking-widest px-2">ประวัติย้อนหลัง</h3>
                                    {Object.keys(groupedRecords).length > 0 ? (
                                        Object.entries(groupedRecords).map(([month, monthRecs]) => (
                                            <MonthGroupHistory key={month} monthLabel={month} records={monthRecs} />
                                        ))
                                    ) : (
                                        <div className="text-center py-10 text-slate-300 font-medium italic">ยังไม่มีข้อมูลการบันทึก</div>
                                    )}
                                </div>
                            </div>
                        )}

                        {view === 'form' && (
                            <div className="animate-slide-up pb-10">
                                <div className="flex items-center justify-between mb-6">
                                    <button onClick={() => setView('dashboard')} className="text-slate-500 hover:bg-white p-2 rounded-xl transition-colors"><SimpleIcon name="ChevronLeft" /></button>
                                    <div className="font-bold text-slate-800">แบบฟอร์มตรวจสอบ</div>
                                    <div className="w-8"></div>
                                </div>
                                
                                <div className="bg-white rounded-[32px] overflow-hidden border border-slate-100 shadow-sm mb-6">
                                    <div className="p-6 grid grid-cols-2 gap-4 bg-slate-50/50">
                                        <div><label className="text-[10px] font-bold text-slate-400 uppercase mb-1 block">วันที่</label><input type="date" className="w-full bg-white border border-slate-200 rounded-xl px-3 py-2.5 text-sm" value={formData.date} onChange={e => setFormData({...formData, date: e.target.value})}/></div>
                                        <div><label className="text-[10px] font-bold text-slate-400 uppercase mb-1 block">เวร</label><select className="w-full bg-white border border-slate-200 rounded-xl px-3 py-2.5 text-sm" value={formData.shift} onChange={e => setFormData({...formData, shift: e.target.value})}><option>ดึก</option><option>เช้า</option><option>บ่าย</option></select></div>
                                    </div>
                                    {CATEGORY_ORDER.map(cat => <CategorySection key={cat} category={cat} items={itemsDef.filter(i => i.category === cat)} formData={formData} updateItem={updateItem} ITEM_TYPES={ITEM_TYPES} />)}
                                    <div className="p-6 bg-slate-50"><label className="text-xs font-bold text-slate-400 mb-2 block">ชื่อผู้ตรวจสอบ</label><input type="text" placeholder="พิมพ์ชื่อ-นามสกุล" className="w-full border border-slate-200 rounded-xl p-3 text-sm focus:ring-2 focus:ring-slate-800 transition-all outline-none" value={formData.checker} onChange={e => setFormData({...formData, checker: e.target.value})}/></div>
                                </div>
                                <button onClick={submitData} className="w-full bg-slate-900 text-white py-4.5 rounded-[24px] font-bold shadow-xl active:scale-95 transition-transform">บันทึกข้อมูล</button>
                            </div>
                        )}
                    </main>

                    {/* MODALS */}
                    <Modal isOpen={showTypeModal} title="เริ่มการตรวจสอบ" onClose={() => setShowTypeModal(false)}>
                        <div className="grid gap-4">
                            <button onClick={() => { setShowTypeModal(false); initForm(); setView('form'); }} className="p-6 bg-[#F0FDF4] rounded-[24px] text-left hover:bg-emerald-100 transition-colors border border-emerald-50 group relative overflow-hidden">
                                <div className="absolute right-0 bottom-0 opacity-10 translate-x-1/4 translate-y-1/4 group-hover:scale-110 transition-transform"><SimpleIcon name="Plus" className="w-24 h-24 text-emerald-600" /></div>
                                <div className="font-bold text-[#065F46] text-xl mb-1">ตรวจสอบใหม่</div>
                                <div className="text-[#059669] text-xs font-medium">สำหรับ Re-Check Stock กรอกใหม่ทั้งหมด</div>
                            </button>
                            <button onClick={() => { setShowTypeModal(false); initForm(records[0]); setShowCopyWarning(true); }} className="p-6 bg-white rounded-[24px] text-left hover:bg-slate-50 transition-colors border border-slate-200 shadow-sm">
                                <div className="font-bold text-slate-800 text-xl mb-1">ดึงรายการล่าสุด</div>
                                <div className="text-slate-500 text-xs font-medium">คัดลอกข้อมูลเดิม (แก้ไขเฉพาะจุด)</div>
                            </button>
                        </div>
                    </Modal>

                    <Modal isOpen={showCopyWarning} title="จุดเน้นย้ำ!" onClose={() => setShowCopyWarning(false)}>
                        <div className="bg-[#FFFBEB] p-6 rounded-[24px] border border-amber-100 mb-6 space-y-5">
                            <div className="flex items-start gap-4">
                                <div className="w-6 h-6 bg-[#FEF3C7] text-amber-800 rounded-full flex items-center justify-center font-bold text-xs shrink-0">1</div>
                                <div className="text-[13px] text-amber-900 leading-relaxed font-medium">Sticker Visual Control ต้องสมบูรณ์ ห้ามฉีกขาด</div>
                            </div>
                            <div className="flex items-start gap-4">
                                <div className="w-6 h-6 bg-[#FEF3C7] text-amber-800 rounded-full flex items-center justify-center font-bold text-xs shrink-0">2</div>
                                <div className="text-[13px] text-amber-900 leading-relaxed font-medium">ตรวจสอบวันหมดอายุยาและเวชภัณฑ์อย่างละเอียด</div>
                            </div>
                            <div className="flex items-start gap-4">
                                <div className="w-6 h-6 bg-[#FEF3C7] text-amber-800 rounded-full flex items-center justify-center font-bold text-xs shrink-0">3</div>
                                <div className="text-[13px] text-amber-900 leading-relaxed font-medium">Laryngoscope ไฟต้องสว่างพร้อมใช้</div>
                            </div>
                        </div>
                        <button onClick={() => { setShowCopyWarning(false); setView('form'); }} className="w-full bg-[#0F172A] text-white py-4 rounded-[20px] font-bold shadow-lg transition-transform active:scale-95">รับทราบและดำเนินการต่อ</button>
                    </Modal>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ErrorBoundary><App /></ErrorBoundary>);
    </script>
</body>
</html>
