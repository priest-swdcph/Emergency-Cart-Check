<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emergency Cart Smart Check</title>
    
    <!-- FAVICON -->
    <link rel="icon" type="image/png" href="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRYfBIvo5I6imKO2PO2Q685aje7a48lvI5rrQ&s">

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', 'Prompt', sans-serif; }
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        .animate-slide-up { animation: slideUp 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        .category-header-button {
            width: 100%;
            height: 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #ffffff;
            border-bottom: 1px solid #f1f5f9;
        }
        .category-header-button svg {
            width: 24px;
            height: 24px;
            stroke-width: 2;
            color: #94a3b8;
        }
    </style>
</head>
<body class="bg-[#F1F5F9] text-slate-800 min-h-screen"> 

    <div id="root"></div>

    <script type="text/babel">
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbwNpFNcLm0iU6vTF0DM7UwONFl3NGXmySuR1jXh-mWyZjbtqf_BTkTpjOYs3NXBzRU/exec"; 

        const { useState, useEffect, useMemo } = React;
        
        // --- HELPERS ---
        const formatDate = (dateStr) => {
            if(!dateStr) return "-";
            try {
                const d = new Date(dateStr);
                return d.toLocaleDateString('th-TH', { year: 'numeric', month: 'short', day: 'numeric' });
            } catch(e) { return "-"; }
        };

        const getDaysDiff = (targetDate) => {
            if (!targetDate) return 999;
            const today = new Date();
            today.setHours(0,0,0,0);
            const target = new Date(targetDate);
            target.setHours(0,0,0,0);
            return Math.ceil((target - today) / (1000 * 60 * 60 * 24));
        };

        // --- Error Boundary ---
        class ErrorBoundary extends React.Component {
            constructor(props) { super(props); this.state = { hasError: false }; }
            static getDerivedStateFromError(error) { return { hasError: true }; }
            componentDidCatch(error, errorInfo) { console.error(error, errorInfo); }
            render() {
                if (this.state.hasError) return (
                    <div className="min-h-screen flex items-center justify-center p-8 text-center">
                        <div className="bg-white p-10 rounded-[40px] shadow-xl border border-red-50">
                            <h2 className="text-2xl font-black text-slate-800 mb-2">ระบบขัดข้อง</h2>
                            <button onClick={() => window.location.reload()} className="bg-slate-900 text-white px-8 py-3 rounded-2xl font-bold">รีโหลด</button>
                        </div>
                    </div>
                );
                return this.props.children; 
            }
        }

        // --- ICONS ---
        const Icons = {
            Plus: <path d="M12 5v14M5 12h14" />,
            CheckCircle: <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14M22 4L12 14.01l-3-3" />,
            XCircle: <><circle cx="12" cy="12" r="10" /><path d="M15 9l-6 6M9 9l6 6" /></>,
            Calendar: <><rect x="3" y="4" width="18" height="18" rx="2" ry="2" /><line x1="16" y1="2" x2="16" y2="6" /><line x1="8" y1="2" x2="8" y2="6" /><line x1="3" y1="10" x2="21" y2="10" /></>,
            ChevronLeft: <polyline points="15 18 9 12 15 6" />,
            ChevronRight: <polyline points="9 18 15 12 9 6" />,
            ChevronDown: <polyline points="6 9 12 15 18 9" />,
            ChevronUp: <polyline points="18 15 12 9 6 15" />,
            Settings: <><circle cx="12" cy="12" r="3" /><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1-2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" /></>,
            Trash: <><polyline points="3 6 5 6 21 6" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /></>,
            Edit: <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />,
            Save: <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2zM17 21v-8H7v8M7 3v5h8" />
        };

        const SimpleIcon = ({ name, className = "w-5 h-5", color = "currentColor" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{Icons[name]}</svg>
        );

        // --- DATA DEFS ---
        const ITEM_TYPES = { 
            QTY_STATUS: 'qty_status', 
            QTY_EXP_STATUS: 'qty_exp_status', 
            CHECK_HAVE: 'check_have', 
            STATUS_ONLY: 'status_only' 
        };

        const CATEGORIES = ['ชั้นบน', 'ลิ้นชักชั้นที่ 1', 'ลิ้นชักชั้นที่ 2', 'ลิ้นชักชั้นที่ 3', 'ตู้ล่างขวา', 'General'];

        const DEFAULT_ITEMS = [
            { id: 'cardiac_board', name: 'Cardiac board', required: 1, type: ITEM_TYPES.QTY_STATUS, category: 'ชั้นบน' },
            { id: 'cpr_box', name: 'กล่องยา CPR', required: 1, type: ITEM_TYPES.QTY_EXP_STATUS, category: 'ชั้นบน' },
            { id: 'acs_box', name: 'กล่องยา ACS', required: 1, type: ITEM_TYPES.QTY_EXP_STATUS, category: 'ชั้นบน' },
            { id: 'laryngoscope', name: 'Laryngoscope', required: 1, type: ITEM_TYPES.QTY_STATUS, category: 'ชั้นบน' },
            { id: 'flashlight', name: 'ไฟฉาย', required: 1, type: ITEM_TYPES.QTY_STATUS, category: 'ชั้นบน' },
            { id: 'mask_4', name: 'Mask NO.4', required: 1, type: ITEM_TYPES.QTY_EXP_STATUS, category: 'ลิ้นชักชั้นที่ 1' },
            { id: 'mask_5', name: 'Mask NO.5', required: 1, type: ITEM_TYPES.QTY_EXP_STATUS, category: 'ลิ้นชักชั้นที่ 1' },
            { id: 'airway_2', name: 'Airway NO.2', type: ITEM_TYPES.QTY_EXP_STATUS, category: 'ลิ้นชักชั้นที่ 1' },
            { id: 'airway_3', name: 'Airway NO.3', type: ITEM_TYPES.QTY_EXP_STATUS, category: 'ลิ้นชักชั้นที่ 1' },
            { id: 'airway_4', name: 'Airway NO.4', type: ITEM_TYPES.QTY_EXP_STATUS, category: 'ลิ้นชักชั้นที่ 1' },
            { id: 'airway_5', name: 'Airway NO.5', type: ITEM_TYPES.QTY_EXP_STATUS, category: 'ลิ้นชักชั้นที่ 1' },
            { id: 'airway_6', name: 'Airway NO.6', type: ITEM_TYPES.QTY_EXP_STATUS, category: 'ลิ้นชักชั้นที่ 1' },
            { id: 'syringe_5', name: 'Syringe 5 CC', type: ITEM_TYPES.QTY_EXP_STATUS, category: 'ลิ้นชักชั้นที่ 1' },
            { id: 'syringe_10', name: 'Syringe 10 CC', type: ITEM_TYPES.QTY_EXP_STATUS, category: 'ลิ้นชักชั้นที่ 1' },
            { id: 'needle_18', name: 'Needle NO.18', type: ITEM_TYPES.QTY_EXP_STATUS, category: 'ลิ้นชักชั้นที่ 1' },
            { id: 'needle_23', name: 'Needle NO.23', type: ITEM_TYPES.QTY_EXP_STATUS, category: 'ลิ้นชักชั้นที่ 1' },
            { id: 'ky_jelly', name: 'KY Jelly', type: ITEM_TYPES.QTY_EXP_STATUS, category: 'ลิ้นชักชั้นที่ 1' },
            { id: 'guide_wire', name: 'Guide wire', required: 5, type: ITEM_TYPES.QTY_EXP_STATUS, category: 'ลิ้นชักชั้นที่ 2' },
            { id: 'ett_5', name: 'ETT NO. 5', required: 2, type: ITEM_TYPES.QTY_EXP_STATUS, category: 'ลิ้นชักชั้นที่ 2' },
            { id: 'ett_5_5', name: 'ETT NO. 5.5', required: 2, type: ITEM_TYPES.QTY_EXP_STATUS, category: 'ลิ้นชักชั้นที่ 2' },
            { id: 'ett_6', name: 'ETT NO. 6', required: 2, type: ITEM_TYPES.QTY_EXP_STATUS, category: 'ลิ้นชักชั้นที่ 2' },
            { id: 'ett_6_5', name: 'ETT NO. 6.5', required: 2, type: ITEM_TYPES.QTY_EXP_STATUS, category: 'ลิ้นชักชั้นที่ 2' },
            { id: 'ett_7', name: 'ETT NO. 7', required: 2, type: ITEM_TYPES.QTY_EXP_STATUS, category: 'ลิ้นชักชั้นที่ 2' },
            { id: 'ett_7_5', name: 'ETT NO. 7.5', required: 2, type: ITEM_TYPES.QTY_EXP_STATUS, category: 'ลิ้นชักชั้นที่ 2' },
            { id: 'ett_8', name: 'ETT NO. 8', required: 2, type: ITEM_TYPES.QTY_EXP_STATUS, category: 'ลิ้นชักชั้นที่ 2' },
            { id: 'suction_14', name: 'Suction NO.14', required: 5, type: ITEM_TYPES.QTY_EXP_STATUS, category: 'ลิ้นชักชั้นที่ 2' },
            { id: 'suction_16', name: 'Suction NO.16', required: 5, type: ITEM_TYPES.QTY_EXP_STATUS, category: 'ลิ้นชักชั้นที่ 2' },
            { id: 'plaster', name: 'พลาสเตอร์ติด Tube', type: ITEM_TYPES.CHECK_HAVE, category: 'ลิ้นชักชั้นที่ 3' },
            { id: 'sterile_gloves', name: 'ถุงมือ Sterile', type: ITEM_TYPES.CHECK_HAVE, category: 'ลิ้นชักชั้นที่ 3' },
            { id: 'gauze', name: 'Gauze', type: ITEM_TYPES.CHECK_HAVE, category: 'ลิ้นชักชั้นที่ 3' },
            { id: 'tongue_depressor', name: 'ไม้กดลิ้น', type: ITEM_TYPES.CHECK_HAVE, category: 'ลิ้นชักชั้นที่ 3' },
            { id: 'ambubag', name: 'Adult ambubag', required: 1, type: ITEM_TYPES.QTY_EXP_STATUS, category: 'ตู้ล่างขวา' },
        ];

        // --- COMPONENTS ---
        const Modal = ({ isOpen, title, children, onClose }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 p-4 backdrop-blur-sm animate-fade-in">
                    <div className="bg-white rounded-[32px] shadow-2xl w-full max-w-[400px] overflow-hidden animate-slide-up">
                        <div className="px-6 py-5 flex justify-between items-center border-b border-slate-50">
                            <h3 className="text-xl font-bold text-slate-800">{title}</h3>
                            <button onClick={onClose} className="text-slate-400 hover:text-slate-600 transition-colors">
                                <SimpleIcon name="XCircle" className="w-7 h-7" />
                            </button>
                        </div>
                        <div className="p-6">{children}</div>
                    </div>
                </div>
            );
        };

        const CategorySection = ({ category, items, formData, updateItem }) => {
            const [isOpen, setIsOpen] = useState(false);
            return (
                <div className="border-t border-slate-100 first:border-t-0 bg-white">
                    <div 
                        onClick={() => setIsOpen(!isOpen)} 
                        className="category-header-button cursor-pointer hover:bg-slate-50 transition-colors"
                    >
                        <SimpleIcon name="ChevronDown" className={`transition-transform duration-300 ${isOpen ? '' : '-rotate-180'}`} />
                        <span className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">{category}</span>
                    </div>
                    {isOpen && (
                        <div className="divide-y divide-slate-100 bg-[#F8FAFC]">
                            {items.map(item => (
                                <div key={item.id} className="p-6">
                                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                                        <div>
                                            <div className="font-bold text-slate-800">{item.name}</div>
                                            {item.required && <div className="text-xs text-slate-400 font-medium">ควรมี: {item.required}</div>}
                                        </div>
                                        <div className="flex p-1 bg-slate-200 rounded-xl w-full sm:w-auto">
                                            {item.type === ITEM_TYPES.CHECK_HAVE ? (
                                                <>
                                                    <button onClick={() => updateItem(item.id, 'checked', true)} className={`flex-1 sm:flex-none px-6 py-2 rounded-lg text-xs font-bold transition-all ${formData.items[item.id]?.checked === true ? 'bg-white text-emerald-600 shadow-sm' : 'text-slate-500'}`}>มี</button>
                                                    <button onClick={() => updateItem(item.id, 'checked', false)} className={`flex-1 sm:flex-none px-6 py-2 rounded-lg text-xs font-bold transition-all ${formData.items[item.id]?.checked === false ? 'bg-white text-red-500 shadow-sm' : 'text-slate-500'}`}>ไม่มี</button>
                                                </>
                                            ) : (
                                                <>
                                                    <button onClick={() => updateItem(item.id, 'status', 'ready')} className={`flex-1 sm:flex-none px-6 py-2 rounded-lg text-xs font-bold transition-all ${formData.items[item.id]?.status === 'ready' ? 'bg-white text-emerald-600 shadow-sm' : 'text-slate-500'}`}>พร้อม</button>
                                                    <button onClick={() => updateItem(item.id, 'status', 'not_ready')} className={`flex-1 sm:flex-none px-6 py-2 rounded-lg text-xs font-bold transition-all ${formData.items[item.id]?.status === 'not_ready' ? 'bg-white text-red-500 shadow-sm' : 'text-slate-500'}`}>ไม่พร้อม</button>
                                                </>
                                            )}
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                        {item.type.includes('qty') && (
                                            <div className="mt-3"><label className="block text-[10px] text-slate-400 mb-1">จำนวนที่ตรวจพบ</label><input type="number" placeholder="ระบุจำนวน" className="w-full bg-white border border-slate-200 rounded-xl px-4 py-2 text-sm focus:ring-2 focus:ring-slate-400 outline-none" value={formData.items[item.id]?.qty || ''} onChange={e => updateItem(item.id, 'qty', e.target.value)}/></div>
                                        )}
                                        {item.type.includes('exp') && (
                                            <div className="mt-3"><label className="block text-[10px] text-slate-400 mb-1">วันหมดอายุ</label><input type="date" className="w-full bg-white border border-slate-200 rounded-xl px-4 py-2 text-sm focus:ring-2 focus:ring-slate-400 outline-none" value={formData.items[item.id]?.exp || ''} onChange={e => updateItem(item.id, 'exp', e.target.value)}/></div>
                                        )}
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        const MonthGroupHistory = ({ monthLabel, records }) => {
            const [isExpanded, setIsExpanded] = useState(true);
            return (
                <div className="mb-4">
                    <button onClick={() => setIsExpanded(!isExpanded)} className="w-full flex items-center justify-between p-4 bg-slate-100 hover:bg-slate-200 rounded-2xl transition-colors mb-2">
                        <div className="flex items-center gap-3">
                            <SimpleIcon name="Calendar" className="w-4 h-4 text-slate-400" />
                            <span className="font-bold text-slate-700 text-sm">{monthLabel}</span>
                            <span className="bg-white text-[10px] text-slate-400 px-2.5 py-1 rounded-full border border-slate-200 font-bold">{records.length} รายการ</span>
                        </div>
                        <SimpleIcon name={isExpanded ? "ChevronUp" : "ChevronDown"} className={`w-4 h-4 text-slate-400`} />
                    </button>
                    {isExpanded && (
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3 animate-fade-in mb-6">
                            {records.map(rec => (
                                <div key={rec.id} className="bg-white p-4 rounded-[24px] border border-slate-100 flex items-center justify-between shadow-sm hover:border-slate-300 transition-colors">
                                    <div className="flex items-center gap-4">
                                        <div className="w-12 h-12 bg-slate-50 rounded-2xl flex items-center justify-center text-slate-400 text-xs font-bold uppercase shrink-0">{rec.shift}</div>
                                        <div>
                                            <div className="font-bold text-slate-800 text-sm">{formatDate(rec.date)}</div>
                                            <div className="text-[10px] text-slate-400 font-medium">โดย: {rec.checker}</div>
                                        </div>
                                    </div>
                                    <div className={`text-[10px] font-bold px-3 py-1 rounded-full shrink-0 ${rec.generalReady === 'พร้อมใช้' ? 'bg-emerald-50 text-emerald-600 border border-emerald-100' : 'bg-red-50 text-red-600 border border-red-100'}`}>{rec.generalReady}</div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        const SubmissionSection = ({ formData, setFormData, onSave }) => {
            const [showOther, setShowOther] = useState(false);
            const [newOther, setNewOther] = useState("");

            const addOther = () => {
                if(!newOther.trim()) return;
                setFormData(prev => ({...prev, otherItems: [...(prev.otherItems || []), newOther]}));
                setNewOther("");
            };

            return (
                <div className="bg-white rounded-[32px] overflow-hidden border border-slate-100 shadow-sm mb-10">
                    <div className="px-8 py-4 bg-slate-50/50 flex items-center justify-between border-b border-slate-100">
                        <div className="flex items-center gap-2">
                            <SimpleIcon name="CheckCircle" className="w-5 h-5 text-slate-400" />
                            <span className="font-bold text-slate-600">สรุปผล</span>
                        </div>
                        <SimpleIcon name="ChevronUp" className="w-4 h-4 text-slate-300" />
                    </div>

                    <div className="p-8 space-y-8">
                        <div className="flex items-center justify-between">
                            <span className="font-bold text-slate-700">ความพร้อมทั่วไปรถ Emergency</span>
                            <div className="flex p-1 bg-slate-100 rounded-xl">
                                <button onClick={() => setFormData({...formData, generalReady: 'พร้อมใช้'})} className={`px-5 py-2 rounded-lg text-xs font-bold transition-all ${formData.generalReady === 'พร้อมใช้' ? 'bg-white text-emerald-600 shadow-sm' : 'text-slate-500'}`}>พร้อม</button>
                                <button onClick={() => setFormData({...formData, generalReady: 'ไม่พร้อมใช้'})} className={`px-5 py-2 rounded-lg text-xs font-bold transition-all ${formData.generalReady === 'ไม่พร้อมใช้' ? 'bg-white text-red-500 shadow-sm' : 'text-slate-500'}`}>ไม่พร้อม</button>
                            </div>
                        </div>

                        <div className="border-t border-slate-50 pt-6">
                            <button onClick={() => setShowOther(!showOther)} className="flex items-center gap-2 text-slate-400 hover:text-slate-600 font-bold mb-4">
                                <SimpleIcon name="Plus" className="w-4 h-4" />
                                <span>รายการอื่นๆ (ถ้ามี)</span>
                                <SimpleIcon name={showOther ? "ChevronUp" : "ChevronDown"} className="w-3 h-3" />
                            </button>
                            {showOther && (
                                <div className="space-y-4 animate-fade-in mb-4">
                                    {(formData.otherItems || []).map((item, idx) => (
                                        <div key={idx} className="flex items-center justify-between bg-slate-50 p-3 rounded-xl border border-slate-100">
                                            <span className="text-sm font-medium text-slate-600">{item}</span>
                                            <button onClick={() => setFormData({...formData, otherItems: formData.otherItems.filter((_,i)=>i!==idx)})} className="text-red-300 hover:text-red-500"><SimpleIcon name="Trash" className="w-4 h-4"/></button>
                                        </div>
                                    ))}
                                    {(!formData.otherItems || formData.otherItems.length === 0) && <div className="text-center text-slate-300 text-xs italic py-4">ไม่มีรายการเพิ่มเติม</div>}
                                    <div className="flex gap-2">
                                        <input type="text" placeholder="ระบุรายการ..." className="flex-1 bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-sm focus:ring-2 focus:ring-slate-400 outline-none" value={newOther} onChange={e=>setNewOther(e.target.value)} onKeyPress={e=>e.key==='Enter'&&addOther()}/>
                                        <button onClick={addOther} className="bg-emerald-50 text-emerald-600 font-bold px-4 py-2 rounded-xl border border-emerald-100">+ เพิ่ม</button>
                                    </div>
                                </div>
                            )}
                        </div>

                        <div className="p-6 bg-emerald-50/30 rounded-[24px] border border-emerald-100/50 flex items-center gap-4">
                            <input type="checkbox" className="w-6 h-6 rounded-lg accent-emerald-600" checked={formData.isRecheckStock} onChange={e => setFormData({...formData, isRecheckStock: e.target.checked})}/>
                            <div>
                                <div className="font-bold text-slate-800 text-sm">บันทึกว่าเป็น ReCheck Stock</div>
                                <div className="text-[10px] text-slate-400">สำหรับการตรวจสอบสต็อกใหญ่ทุก 2 สัปดาห์</div>
                            </div>
                        </div>

                        <div className="space-y-3">
                            <label className="text-xs font-bold text-slate-600">ลงชื่อผู้ตรวจสอบ <span className="text-red-500">*</span></label>
                            <input type="text" placeholder="พิมพ์ชื่อ-นามสกุลของคุณ" className="w-full border border-slate-200 rounded-2xl p-4 text-sm focus:ring-2 focus:ring-slate-800 outline-none bg-white shadow-sm" value={formData.checker} onChange={e => setFormData({...formData, checker: e.target.value})}/>
                        </div>

                        <button onClick={onSave} className="w-full bg-[#0F172A] hover:bg-slate-800 text-white py-5 rounded-[24px] font-bold shadow-2xl active:scale-95 text-lg flex items-center justify-center gap-3 transition-all mt-4">
                            <SimpleIcon name="Save" className="w-6 h-6" />
                            <span>บันทึกข้อมูล</span>
                        </button>
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        function App() {
            const [view, setView] = useState('dashboard');
            const [itemsDef, setItemsDef] = useState(DEFAULT_ITEMS); 
            const [records, setRecords] = useState([]);
            const [formData, setFormData] = useState({});
            const [lastStockCheck, setLastStockCheck] = useState(null);
            const [isLoading, setIsLoading] = useState(false);
            
            const [editForm, setEditForm] = useState({ id: null, name: '', category: 'ชั้นบน', type: ITEM_TYPES.QTY_STATUS, required: '' });
            const [isEditing, setIsEditing] = useState(false);

            const [showTypeModal, setShowTypeModal] = useState(false);
            const [showCopyWarning, setShowCopyWarning] = useState(false);

            useEffect(() => { 
                fetchData(); 
                const savedItems = localStorage.getItem('smartcheck_items');
                if(savedItems) setItemsDef(JSON.parse(savedItems));
            }, []);

            useEffect(() => {
                localStorage.setItem('smartcheck_items', JSON.stringify(itemsDef));
            }, [itemsDef]);

            const fetchData = async () => {
                setIsLoading(true);
                try {
                    const res = await fetch(GAS_API_URL + '?action=read');
                    const json = await res.json();
                    if(json.status === 'success') {
                         setRecords((json.data || []).map(r => ({...r, items: typeof r.items === 'string' ? JSON.parse(r.items) : (r.items || {})})));
                    }
                    const resStock = await fetch(GAS_API_URL + '?action=getLastStockCheck');
                    const dataStock = await resStock.json();
                    if(dataStock.status === 'success' && dataStock.date) setLastStockCheck(new Date(dataStock.date));
                } catch (e) {
                    setRecords([{ id: Date.now(), date: new Date().toISOString(), generalReady: 'พร้อมใช้', shift: 'เช้า', checker: 'Demo User', items: {} }]);
                } finally { setIsLoading(false); }
            };

            const initForm = (prevData = null) => {
                const today = new Date().toISOString().split('T')[0];
                const savedChecker = localStorage.getItem('last_checker') || '';
                let initialItems = {};
                itemsDef.forEach(i => initialItems[i.id] = { qty: '', exp: '', status: null, checked: null, note: '' });
                if (prevData) Object.entries(prevData.items || {}).forEach(([k, v]) => { if (initialItems[k]) initialItems[k] = { ...v }; });
                setFormData({ 
                    date: today, shift: 'เช้า', checker: savedChecker, 
                    items: initialItems, otherItems: [], isRecheckStock: false,
                    generalReady: 'พร้อมใช้' 
                });
            };

            const submitData = async () => {
                if(!formData.checker) { alert("กรุณาลงชื่อผู้ตรวจสอบ"); return; }
                setIsLoading(true);
                localStorage.setItem('last_checker', formData.checker);
                try {
                    await fetch(GAS_API_URL, {
                        method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'text/plain' },
                        body: JSON.stringify({ ...formData, id: Date.now() })
                    });
                    if(formData.isRecheckStock) await fetch(GAS_API_URL + '?action=updateLastStockCheck&date=' + formData.date);
                    setTimeout(() => { setIsLoading(false); setView('dashboard'); fetchData(); }, 1500);
                } catch (e) { setIsLoading(false); }
            };

            const moveItem = (index, direction) => {
                const newItems = [...itemsDef];
                const targetIdx = direction === 'up' ? index - 1 : index + 1;
                if(targetIdx < 0 || targetIdx >= newItems.length) return;
                if(newItems[index].category !== newItems[targetIdx].category) return;
                const temp = newItems[index];
                newItems[index] = newItems[targetIdx];
                newItems[targetIdx] = temp;
                setItemsDef(newItems);
            };

            const updateItemDef = () => {
                if(!editForm.name) return;
                if(isEditing) {
                    setItemsDef(prev => prev.map(item => item.id === editForm.id ? { ...editForm } : item));
                    setIsEditing(false);
                } else {
                    setItemsDef(prev => [...prev, { ...editForm, id: Date.now().toString() }]);
                }
                setEditForm({ id: null, name: '', category: 'ชั้นบน', type: ITEM_TYPES.QTY_STATUS, required: '' });
            };

            const deleteItemDef = (id) => {
                if(confirm('ต้องการลบรายการนี้ใช่หรือไม่?')) setItemsDef(prev => prev.filter(i => i.id !== id));
            };

            const updateItemValue = (id, field, value) => setFormData(prev => ({ ...prev, items: { ...prev.items, [id]: { ...prev.items[id], [field]: value } } }));

            const groupedRecords = useMemo(() => {
                const groups = {};
                records.forEach(rec => {
                    const d = new Date(rec.date);
                    const label = d.toLocaleDateString('th-TH', { month: 'long', year: 'numeric' });
                    if (!groups[label]) groups[label] = [];
                    groups[label].push(rec);
                });
                return groups;
            }, [records]);

            if (isLoading) return <div className="min-h-screen flex items-center justify-center bg-white"><div className="w-12 h-12 border-4 border-t-slate-800 rounded-full animate-spin"></div></div>;

            return (
                <div className="w-full max-w-4xl mx-auto min-h-screen bg-white md:shadow-2xl flex flex-col overflow-hidden">
                    <header className="bg-white px-6 py-6 border-b border-slate-100 flex items-center justify-between sticky top-0 z-30">
                        <div className="flex items-center gap-4">
                            <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRYfBIvo5I6imKO2PO2Q685aje7a48lvI5rrQ&s" className="w-12 h-12 rounded-xl object-cover shadow-sm"/>
                            <div>
                                <h1 className="text-lg md:text-xl font-extrabold text-slate-800 leading-none mb-1">Emergency Cart Check</h1>
                                <p className="text-[13px] font-bold text-slate-500">หอสงฆ์อาพาธ</p>
                            </div>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={() => setView('dashboard')} className={`p-2.5 rounded-xl transition-colors ${view === 'dashboard' ? 'bg-slate-100 text-slate-900' : 'text-slate-400'}`}><SimpleIcon name="Calendar" /></button>
                            <button onClick={() => setView('settings')} className={`p-2.5 rounded-xl transition-colors ${view === 'settings' ? 'bg-slate-100 text-slate-900' : 'text-slate-400'}`}><SimpleIcon name="Settings" /></button>
                        </div>
                    </header>

                    <main className="flex-1 bg-[#F8FAFC]">
                        {view === 'dashboard' && (
                            <div className="p-4 md:p-8 space-y-8 animate-fade-in max-w-3xl mx-auto">
                                <div className="bg-white rounded-[40px] p-8 md:p-12 shadow-sm border border-slate-100 text-center relative overflow-hidden">
                                    <h2 className="text-slate-400 text-[10px] md:text-xs font-bold uppercase tracking-[2px] mb-6">ความพร้อมทั่วไปรถ EMERGENCY หอสงฆ์อาพาธ</h2>
                                    <div className={`text-6xl md:text-8xl font-black mb-8 ${records[0]?.generalReady === 'พร้อมใช้' ? 'text-[#10B981]' : 'text-red-500'}`}>
                                        {records[0]?.generalReady || 'พร้อมใช้'}
                                    </div>
                                    <div className="inline-flex items-center gap-3 bg-slate-50 px-6 py-3 rounded-2xl text-[13px] md:text-sm text-slate-600 mb-10 border border-slate-100 shadow-inner">
                                        <SimpleIcon name="RotateCcw" className="w-4 h-4 text-slate-300" />
                                        <span>กำหนด ReCheck Stock ครั้งถัดไป: <span className="font-bold text-slate-800 ml-1">{lastStockCheck ? formatDate(new Date(lastStockCheck.getTime() + 14 * 86400000)) : '12 ก.พ. 2569'}</span></span>
                                    </div>
                                    <div className="max-w-md mx-auto">
                                        <button onClick={() => setShowTypeModal(true)} className="w-full bg-[#0F172A] hover:bg-slate-800 text-white py-5 rounded-[24px] shadow-xl flex items-center justify-center gap-3 text-lg font-bold transition-transform active:scale-95">
                                            <SimpleIcon name="Plus" className="w-6 h-6 text-white" />
                                            <span>ตรวจสอบรถ</span>
                                        </button>
                                    </div>
                                </div>
                                <div className="space-y-4">
                                    <h3 className="text-sm font-bold text-slate-400 uppercase tracking-widest px-2">ประวัติย้อนหลัง</h3>
                                    {Object.entries(groupedRecords).map(([month, monthRecs]) => (
                                        <MonthGroupHistory key={month} monthLabel={month} records={monthRecs} />
                                    ))}
                                </div>
                            </div>
                        )}

                        {view === 'settings' && (
                            <div className="p-4 md:p-8 animate-slide-up max-w-3xl mx-auto pb-20">
                                <div className="bg-white rounded-[32px] p-8 shadow-sm border border-slate-100 mb-8">
                                    <div className="flex items-center gap-2 mb-6 text-orange-500">
                                        <SimpleIcon name="Edit" />
                                        <h2 className="font-bold text-slate-800">{isEditing ? 'แก้ไขรายการ' : 'เพิ่มรายการใหม่'}</h2>
                                    </div>
                                    <div className="grid grid-cols-1 gap-4">
                                        <select className="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3" value={editForm.category} onChange={e => setEditForm({...editForm, category: e.target.value})}>
                                            {CATEGORIES.map(c => <option key={c}>{c}</option>)}
                                        </select>
                                        <input type="text" placeholder="ชื่อรายการเวชภัณฑ์" className="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 outline-none" value={editForm.name} onChange={e => setEditForm({...editForm, name: e.target.value})}/>
                                        <div className="grid grid-cols-2 gap-4">
                                            <select className="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3" value={editForm.type} onChange={e => setEditForm({...editForm, type: e.target.value})}>
                                                <option value="qty_status">จำนวน+สถานะ</option>
                                                <option value="qty_exp_status">จำนวน+วันหมดอายุ</option>
                                                <option value="check_have">มี/ไม่มี</option>
                                                <option value="status_only">สถานะอย่างเดียว</option>
                                            </select>
                                            <input type="number" placeholder="ควรมี" className="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3" value={editForm.required} onChange={e => setEditForm({...editForm, required: e.target.value})}/>
                                        </div>
                                        <div className="grid grid-cols-2 gap-4 mt-2">
                                            <button onClick={updateItemDef} className="bg-orange-500 text-white font-bold py-4 rounded-2xl">อัปเดต</button>
                                            <button onClick={() => { setIsEditing(false); setEditForm({id:null, name:'', category:'ชั้นบน', type:ITEM_TYPES.QTY_STATUS, required:''}); }} className="bg-slate-200 text-slate-600 font-bold py-4 rounded-2xl">ยกเลิก</button>
                                        </div>
                                    </div>
                                </div>
                                <div className="space-y-6">
                                    {CATEGORIES.map(cat => {
                                        const catItems = itemsDef.filter(i => i.category === cat);
                                        if (catItems.length === 0) return null;
                                        return (
                                            <div key={cat} className="bg-white rounded-[24px] border border-slate-100 overflow-hidden shadow-sm">
                                                <div className="bg-slate-50 px-6 py-3 text-[10px] font-bold text-slate-400 uppercase tracking-widest">{cat}</div>
                                                <div className="divide-y divide-slate-50">
                                                    {itemsDef.map((item, idx) => {
                                                        if(item.category !== cat) return null;
                                                        return (
                                                            <div key={item.id} className="p-4 flex items-center justify-between hover:bg-slate-50/50">
                                                                <div className="flex items-center gap-2">
                                                                    <div className="flex flex-col">
                                                                        <button onClick={() => moveItem(idx, 'up')} className="p-1 text-slate-300 hover:text-slate-600"><SimpleIcon name="ChevronUp" className="w-3 h-3"/></button>
                                                                        <button onClick={() => moveItem(idx, 'down')} className="p-1 text-slate-300 hover:text-slate-600"><SimpleIcon name="ChevronDown" className="w-3 h-3"/></button>
                                                                    </div>
                                                                    <div className="font-bold text-slate-700 ml-2">{item.name}</div>
                                                                </div>
                                                                <div className="flex items-center gap-1">
                                                                    <button onClick={() => { setIsEditing(true); setEditForm(item); window.scrollTo({top: 0, behavior: 'smooth'}); }} className="p-2 text-slate-300 hover:text-slate-500"><SimpleIcon name="Edit" className="w-4 h-4" /></button>
                                                                    <button onClick={() => deleteItemDef(item.id)} className="p-2 text-slate-300 hover:text-red-500"><SimpleIcon name="Trash" className="w-4 h-4" /></button>
                                                                </div>
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}

                        {view === 'form' && (
                            <div className="animate-slide-up pb-20 max-w-2xl mx-auto">
                                <div className="flex items-center justify-between p-8">
                                    <button onClick={() => setView('dashboard')} className="text-slate-500 hover:bg-white p-3 rounded-2xl bg-white shadow-sm"><SimpleIcon name="ChevronLeft" /></button>
                                    <div className="font-bold text-lg text-slate-800">แบบฟอร์มตรวจสอบ</div>
                                    <div className="w-12"></div>
                                </div>
                                <div className="bg-white rounded-[32px] overflow-hidden border border-slate-100 shadow-sm mb-8">
                                    <div className="p-8 grid grid-cols-1 sm:grid-cols-2 gap-6 bg-slate-50/50 border-b border-slate-100">
                                        <div><label className="text-[10px] font-bold text-slate-400 uppercase mb-2 block">วันที่</label><input type="date" className="w-full bg-white border border-slate-200 rounded-xl px-4 py-3" value={formData.date} onChange={e => setFormData({...formData, date: e.target.value})}/></div>
                                        <div><label className="text-[10px] font-bold text-slate-400 uppercase mb-2 block">เวร</label><select className="w-full bg-white border border-slate-200 rounded-xl px-4 py-3" value={formData.shift} onChange={e => setFormData({...formData, shift: e.target.value})}><option>ดึก</option><option>เช้า</option><option>บ่าย</option></select></div>
                                    </div>
                                    {CATEGORIES.map(cat => cat !== 'General' && itemsDef.some(i=>i.category===cat) && <CategorySection key={cat} category={cat} items={itemsDef.filter(i => i.category === cat)} formData={formData} updateItem={updateItemValue} />)}
                                </div>
                                <SubmissionSection formData={formData} setFormData={setFormData} onSave={submitData} />
                            </div>
                        )}
                    </main>

                    <Modal isOpen={showTypeModal} title="เริ่มการตรวจสอบ" onClose={() => setShowTypeModal(false)}>
                        <div className="grid gap-4">
                            <button onClick={() => { setShowTypeModal(false); initForm(); setView('form'); }} className="p-6 bg-[#F0FDF4] rounded-[24px] text-left hover:bg-emerald-100 border border-emerald-50 group relative overflow-hidden transition-all">
                                <div className="absolute right-0 bottom-0 opacity-10 translate-x-1/4 translate-y-1/4 group-hover:scale-110 transition-transform"><SimpleIcon name="Plus" className="w-24 h-24 text-emerald-600" /></div>
                                <div className="font-bold text-[#065F46] text-xl mb-1">ตรวจสอบใหม่</div>
                                <div className="text-[#059669] text-xs font-medium">สำหรับ Re-Check Stock กรอกใหม่ทั้งหมด</div>
                            </button>
                            <button onClick={() => { setShowTypeModal(false); initForm(records[0]); setShowCopyWarning(true); }} className="p-6 bg-white rounded-[24px] text-left hover:bg-slate-50 border border-slate-200 shadow-sm transition-all">
                                <div className="font-bold text-slate-800 text-xl mb-1">ดึงรายการล่าสุด</div>
                                <div className="text-slate-500 text-xs font-medium">คัดลอกข้อมูลเดิม (แก้ไขเฉพาะจุด)</div>
                            </button>
                        </div>
                    </Modal>

                    <Modal isOpen={showCopyWarning} title="จุดเน้นย้ำ!" onClose={() => setShowCopyWarning(false)}>
                        <div className="bg-[#FFFBEB] p-8 rounded-[32px] border border-amber-100 mb-8 space-y-6">
                            {[
                                "Sticker Visual Control ต้องสมบูรณ์ ห้ามฉีกขาด",
                                "ตรวจสอบวันหมดอายุยาและเวชภัณฑ์อย่างละเอียด",
                                "Laryngoscope ไฟต้องสว่างพร้อมใช้"
                            ].map((text, idx) => (
                                <div key={idx} className="flex items-start gap-5">
                                    <div className="w-8 h-8 bg-[#FEF3C7] text-amber-800 rounded-full flex items-center justify-center font-bold text-sm shrink-0 shadow-sm">{idx + 1}</div>
                                    <div className="text-[14px] text-amber-900 leading-relaxed font-semibold">{text}</div>
                                </div>
                            ))}
                        </div>
                        <button onClick={() => { setShowCopyWarning(false); setView('form'); }} className="w-full bg-[#0F172A] text-white py-5 rounded-[24px] font-bold shadow-xl active:scale-95 text-lg">รับทราบและดำเนินการต่อ</button>
                    </Modal>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ErrorBoundary><App /></ErrorBoundary>);
    </script>
</body>
</html>
